<!doctype html>
<html lang="en" class="no-js">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
	<link rel="stylesheet" href="css/reset.css"> 
	<link rel="stylesheet" href="css/style.css"> <!-- Resource style -->
    <script>
    
        const {shell} = require('electron');
        const {dialog} = require('electron').remote;
        var fs = require('fs');

    </script>
    <title>JMU Advisor Schedule Printer</title>
</head>
<body>

<div class="canvas">
    
<div id="loadView" class="dialog">
    <h1>Load CSV</h1>
    <p>
        <strong>Instructions: </strong> Log in to <a href="javascript:shell.openExternal('https://sa.jmu.edu');">https://sa.jmu.edu</a> and run the JCOMPSCI05 query using the Excel link. 
        Download the Excel file for your query and open it in Excel. Then export it as a CSV file and use the buttons
        below to load the exported CSV file.
    </p>
    <center>
        <input type="button" onclick="loadCSV()" value="Load CSV File" />
    </center>
</div>

<div id="studentListView" class="dialog hidden">
    <strong>Student: </strong>
    <select id="students" style="font-size: 16pt;" onchange="showSchedule(this)">
        <option value="">---Select a student---</option>
    </select>
</div>

<div id="scheduleView" class="schedule hidden">

</div>

</div>


<script>window.$ = window.jQuery = require('jquery');</script>
<script>
	if( !window.jQuery ) document.write('<script src="js/jquery-3.0.0.min.js"><\/script>');

	function addEvent(day, startTime, endTime, eventName) {
		var evtStr =
			'<li class="single-event" data-start="' + startTime + '" data-end="' + endTime + '" data-content="event-abs-circuit" data-event="event-1">' +
			'	<a href="#0">' +
			'		<em class="event-name">' + eventName + '</em>' +
			'	</a>' +
			'</li>';
		$(evtStr).appendTo($("ul#" + day));
	}

	function clearAll() {
		$("ul#monday").empty();
		$("ul#tuesday").empty();
		$("ul#wednesday").empty();
		$("ul#thursday").empty();
		$("ul#friday").empty();
	}

	addEvent("monday", "9:30", "10:30", "Myevent");

	// $(document).ready(function() {
	//     $.ajax({
	//         type: "GET",
	//         url: "JCOMPSCI05.csv",
	//         dataType: "text",
	//         success: function(data) {processData(data);}
	//      });
	// });

	// This will parse a delimited string into an array of
	// arrays. The default delimiter is the comma, but this
	// can be overriden in the second argument.
	function CSVToArray( strData, strDelimiter ){
		// Check to see if the delimiter is defined. If not,
		// then default to comma.
		strDelimiter = (strDelimiter || ",");
		// Create a regular expression to parse the CSV values.
		var objPattern = new RegExp(
			(
				// Delimiters.
				"(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
				// Quoted fields.
				"(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
				// Standard fields.
				"([^\"\\" + strDelimiter + "\\r\\n]*))"
			),
			"gi"
			);
		// Create an array to hold our data. Give the array
		// a default empty first row.
		var arrData = [[]];
		// Create an array to hold our individual pattern
		// matching groups.
		var arrMatches = null;
		// Keep looping over the regular expression matches
		// until we can no longer find a match.
		while (arrMatches = objPattern.exec( strData )){
			// Get the delimiter that was found.
			var strMatchedDelimiter = arrMatches[ 1 ];
			// Check to see if the given delimiter has a length
			// (is not the start of string) and if it matches
			// field delimiter. If id does not, then we know
			// that this delimiter is a row delimiter.
			if (
				strMatchedDelimiter.length &&
				(strMatchedDelimiter != strDelimiter)
				){
				// Since we have reached a new row of data,
				// add an empty row to our data array.
				arrData.push( [] );
			}
			// Now that we have our delimiter out of the way,
			// let's check to see which kind of value we
			// captured (quoted or unquoted).
			if (arrMatches[ 2 ]){
				// We found a quoted value. When we capture
				// this value, unescape any double quotes.
				var strMatchedValue = arrMatches[ 2 ].replace(
					new RegExp( "\"\"", "g" ),
					"\""
					);
			} else {
				// We found a non-quoted value.
				var strMatchedValue = arrMatches[ 3 ];
			}
			// Now that we have our value string, let's add
			// it to the data array.
			arrData[ arrData.length - 1 ].push( strMatchedValue );
		}
		// Return the parsed data.
		return( arrData );
	}

    function loadCSV() {
        dialog.showOpenDialog({properties: ['openFile'], filters:[{ name: 'CSV Files', extensions: ['csv'] }]}, 
            function (filenames) {
                if (filenames === undefined) return;
                var filename = filenames[0];
                fs.readFile(filename, 'utf-8', function (err, data) {
                    if (err) {
                        alert("Error reading file.");
                        return; 
                    }

                    // Convert the CSV data to an array
                    var csvData = CSVToArray(data, ",");

                    var eids = [];
                    
                    // Grab the student records. 
                    var studentRecs = csvData.slice(2, csvData.length);

                    // Add the unique eids in order
                    var lastEid = undefined;
                    studentRecs.forEach( function(line) {
                        var eid = line[1];
                        if (lastEid !== eid) {
                            eids.push(eid);
                            lastEid = eid;
                        }
                    });

                    // Create a dictionary of eid's to schedule lines:
                    var students = {};

                    studentRecs.forEach( function (line) {
                        var eid = line[1];
                        if (students[eid] === undefined) {
                            students[eid] = [];
                        }
                        students[eid].push(line);
                    });

                    $("select#students").find("option").remove().end().append('<option>---Select a student---</option>').val('');
                    eids.forEach(function (eid) {
                        $('<option value="' + eid + '">' + students[eid][0][2] + '</option>').appendTo($("select#students"));
                    });

                    $("#loadView").hide();
                    $("#studentListView").show();
                    $("#scheduleView").show();

                    $("select#students").data("eids", eids);
                    $("select#students").data("schedules", students)
                    
                });
            }
        );

        /*fs.readFile(fileChooser.value, 'utf8', function (err,data) {
            if (err) {
                return alert(err);
            }
            console.log(data);
        });*/
    }

    function showSchedule(select) {
        var $select = $(select);

        var schedule = $select.data("schedules")[$select.val()];
        
        alert(schedule);
        console.log(schedule);
    }
/*
	var cvsStr = "";

	var csvData2 = CSVToArray(csvStr, ",");

	var eids = [];

	// Extract the CSV
	var studentRecs = csvData2.slice(1, csvData2.length);

	// Find the unique eids in order:
	eids.push(studentRecs[0][1]);
	for (var i = 1; i < studentRecs.length; i++) {
		if (eids[eids.length - 1] != studentRecs[i][1]) {
			eids.push(studentRecs[i][1]);
		}
	}

	// Create a dictionary of eid's to schedule lines:
	var students = {};

	studentRecs.forEach( function (line) {
		var eid = line[1];
		if (students[eid] === undefined) {
			students[eid] = [];
		}
		students[eid].push(line);
	});


		function getQueryVariable(variable)
		{
		       var query = window.location.search.substring(1);
		       var vars = query.split("&");
		       for (var i=0;i<vars.length;i++) {
		               var pair = vars[i].split("=");
		               if(pair[0] == variable){return pair[1];}
		       }
		       return(false);
		}

	     var eid = getQueryVariable("eid");

	// Populate the student dropdown
	var x = 0;
	for (var i = 0; i < eids.length; i++) {
		var theEid = eids[i];
		if (theEid == getQueryVariable("eid")) {
			$('<option value="' + theEid + '" selected>' + students[theEid][0][2] + '</option>').appendTo($("select#students"));
		} else {
			$('<option value="' + theEid + '">' + students[theEid][0][2] + '</option>').appendTo($("select#students"));
		}
	}

	$("select#students").on("change", function(event) {
		window.location.href = "?eid=" + this.value;
	} );

	 clearAll();
	 if (eid != "") {
		 //addEvent("monday", "9:30", "10:30", "Myevent");
		 var schedule = students[eid];
		 schedule.forEach(function (courseRec) {

			var courseNum = courseRec[3];
			var courseTitle = courseRec[5];
			var courseStart = courseRec[6].replace(".", ":");
			var courseEnd = courseRec[7].replace(".", ":");
			var location = courseRec[13];

			var days = [];
			if (courseRec[8] == "Y") days.push("monday");
			if (courseRec[9] == "Y") days.push("tuesday");
			if (courseRec[10] == "Y") days.push("wednesday");
			if (courseRec[11] == "Y") days.push("thursday");
			if (courseRec[12] == "Y") days.push("friday");

			days.forEach(function (day) {
				addEvent(day, courseStart, courseEnd,
					courseNum + "; " + location + ""
				);
			});

		 });
     }
     */

</script>
<!--script src="js/main.js"></script> <!-- Resource jQuery -->
</body>
</html>
